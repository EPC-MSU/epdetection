# detection

Описание модуля detection и того что в нём лежит. Автор: Маракулин Андрей. Дата: 30.07.2021

Модуль представляет из себя набор функций для распознавания компонентов на печатных платах. (см. elements.md). Существует пять публичных функций, которыми следует пользоваться импортируя модуль.

## Примеры запуска

Активация виртуального окружения:

* Открыть консоль в папке venv/Scripts
* Прописать в консоли ```activate```, теперь команды из консоли будут выполняться в виртуальном окружении.
* Перейти обратно в корневую папку eye-point можно командой `cd ../..`

Пример запуска распознавания из командной строки (полный список аргументов смотрите через `--help`):

```bash
python -m detection --image tests//elm_test1/image.png --draw-elements
```

Пример запуска unit тестов

```bash
python -m unittest discover test
```

Пример запуска из кода python:

```python
import cv2
from detection.detect import detect_elements
from detection.utils import FakeGuiConnector

gc = FakeGuiConnector()
img = cv2.imread("my_folder/my_image.png")
result = detect_elements(gc, img, trh_prob=0.7, trh_corr_mult=1.5)
```
## Описание модуля
```
doc - папка с описанием модуля и элементов
detection/
	detect.py - основной файл с функциями распознавания. Есть зависимость от utils и train.
	train.py - файл для обучения классификтаторов. Есть зависимость от utils.
	utils.py - мелкие функции, математика.
tests - папка с unit тестами
__init__.py
```

## detect.py

Распознавание происходит следующим образом:

* На элементах был заранее обучен SGD-классификатор. Он подгружается в класс Detector из файла .dump
* Выбор dump файла зависит от вызываемой функции, поскольку для разных элементов разные классификаторы.
* По входной картинке проходятся корреляционной функцией TM_CCOEFF_NORMED и получают карту корреляций для выбранных элементов. (В логе выглядит как Peaks)
* Далее отбираются самые сильные пики корреляционной карты (они названы non_overlap_hyp)
* Эти пики уточняются, считаются вероятности расположения элемента в предполагаемом положении.
* В зависимости от предполагаемого класса, выполняются так же дополнительные действия. Например если найден край многоного элемента, то с помощью фурье-анализа находятся пины между несколькими углами.
* Далее отсеиваются пересекающиеся совпадения.
* Координаты с указанием класса и пинов собираются в класс Element
* Сопоставля по имени найденные элементы с файлом sizes определяются шириан и высота корпусов.
* Возвращается лист с Element-ами

#### `get_element_names_by_mode`

Возвращает список имён элементов для соответствующего режима: `BGA` или `PCB`. В EyePoint используется для формирования окна настроек.


#### `detect_elements`
Основной функцией является  detect_all, она принимает изображение и параметры. Возвращает лист из классов Element.

Аргументы:

`gc` - GuiConnector (или наследник). Служит для управления прогресс-барами и прерыванием в основной программе. Управление барами захардкожено внутрь, поэтому если надобности в прогресс барах нет, то используйте utils.py/FakeGuiConnector

`img` - rgb изображение платы np.array

`trh_prob` - порог классификатора. Элементы с вероятностью ниже порога отсеиваются.

`trh_corr_mult` - коэффициент классификатора. Отвечает за порог нахождения элементов внутри непересекающихся гипотез.
`find_one` - искать один элемент на изображении или несколько.
`elements_offset` - смещение координат. Когда распознавание происходит в выделенной рамке, то эта изображение в рамке отправляется в detect_all, распознавание происходит в координатной системе рамке, а после elements_offset используется для получения координат в системе всего изображения.
`debug_dir` - директория для дебага.
`det_names` - лист с названиями элементов для распознавания или None
`bga_szk` - что-то связанное с размерами bga

Возвращает:
`elements` -  лист классов Element

#### `detect_label`

Функция для нахождения на изображении шахматной доски калибровочной платы. Возвращает лист из одного элемента. У которого bounding box определяет границы шахматной доски. А так же в  pins два пина: один на шахматной доске, второй на контактной площадке.

`gc` - см. выше

`img`- см. выше

#### `detect_BGA`

Входные параметры идентичны detect_elements. В аргументе det_names должно быть 'BGA'

Возвращает лист из BGA элементов.

#### `detect_BGA_params`
Вспомогательная функция для распознавания BGA. Используется для нахождения попорота платы. Поэтому вызывается по окончанию сканирования платы, ещё до распознавания (И для того чтобы найти поворот распознаёт компоненты).

Аргументы:

`gc` - см. выше
`img`- см. выше
`types_filename`- см. выше

`pix_per_mm` - количество пикселей на миллиметр.

Возвращает:
`ang` - угол в градусах, на который следует повернуть плату
`pitch` - используется для сравнения с BGA эталонами
`points` - используется для сравнения с BGA эталонами

## train.py

Файл для обучения классификаторов. Вызывается из командной строки.

Для того чтобы обучение началось, в папку dumps нужно положить датасет элементов.

## utils.py
Множество математических функций, использующихся в распознавании, но способных существовать отдельно.

## dumps

    clf_bga.dump - сохраненные внутренности класса Detector с обученным классификатором для bga
    clf_types.dump - сохраненные внутренности класса Detector с обученным классификатором для других типов
    clf_label.dump - классификатор для шахматной доски на калибровочной плате.
    
    bga.csv - файл с описанием для bga
    label.csv - файл с описанием элемента (шахматной доски). Классификатор вроде зашит в clf_types.
    types.csv - файл с описанием для других типов
    sizes.csv - реальные размеры корпусов элементов
    
    clusters.txt - файл с кластерами элементов, используется в обучении. Предназначение не ясно.