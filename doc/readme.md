# detection

Краткая инструкция к модулю detection и тому что в нём лежит. Автор: Маракулин Андрей. Дата: 20.07.2021

Модуль представляет из себя набор функций для распознавания компонентов на печатных платах. (см. elements.md). Существует две основные функции, которыми следует пользоваться импортируя модуль: detect_all и detect_BGA_params

## Примеры запуска

Активация виртуального окружения:

* Открыть консоль в папке venv/Scripts
* Прописать в консоли ```activate```, теперь команды из консоли будут выполняться в виртуальном окружении.
* Перейти обратно в корневую папку eye-point можно командой `cd ../..`

Пример запуска распознавания из командной строки (полный список аргументов смотрите через `--help`):

```bash
python -m detection --image detection//tests//elm_test1/image.png --draw-elements
```

Пример запуска unit тестов

```bash
python -m unittest discover detection
```

Пример запуска из кода python:

```python
import cv2
from detection.detect import detect_all
from detection.utils import FakeGuiConnector

gc = FakeGuiConnector()
img = cv2.imread("my_folder/my_image.png")
result = detect_all(gc, img, "detection/dumps/types.csv", trh_prob=0.7, trh_corr_mult=1.5)
```
## Описание модуля
```
detect.py - основной файл с функциями распознавания. Есть зависимость от utils и train.
train.py - файл для обучения классификтаторов. Есть зависимость от utils.
utils.py - мелкие функции, математика.
tests - папка с unit тестами
__init__.py
```

## detect.py

Распознавание происходит следующим образом:

* На элементах был заранее обучен SGD-классификатор. Он содержится в классе Detector
* Detector подгружается из dump файла вместе с паттернами элементов и некоторыми параметрами.
* По входной картинке проходятся корреляционной функцией TM_CCOEFF_NORMED и получают карту корреляций для выбранных элементов. (В логе выглядит как Peaks)
* Далее отбираются самые сильные пики корреляционной карты (они названы non_overlap_hyp)
* Эти пики уточняются, считаются вероятности расположения элемента в предполагаемом положении.
* В зависимости от предполагаемого класса, выполняются так же дополнительные действия. Например если найден край многоного элемента, то с помощью фурье-анализа находятся пины между несколькими углами.
* Далее отсеиваются пересекающиеся совпадения.
* Координаты с указанием класса и пинов собираются в класс Element
* Возвращается лист с Element-ами

Вызовы функций при всевозможных входных параметров представлены ниже:

<img src="C:\dev\eyepoint-src\detection\doc\1.6_detect_14-07-21.svg" style="zoom:60%;" />

#### `detect_all`
Основной функцией является  detect_all, она принимает изображение и параметры. Возвращает лист из классов Element.

Аргументы:

`gc` - GuiConnector (или наследник). Служит для управления прогресс-барами и прерыванием в основной программе. Управление барами захардкожено внутрь, поэтому если надобности в прогресс барах нет, то используйте utils.py/FakeGuiConnector

`img` - rgb изображение платы np.array

`types_filename` - detection\dumps\types.csv или  detection\dumps\bga.csv - путь на файл с списком и параметрами компонентов. В ЕР10 используется как определитель что именно детектировать, BGA или всё остальное.

`trh_prob` - порог классификатора. Элементы с вероятностью ниже порога отсеиваются.

`trh_corr_mult` - коэффициент классификатора. Отвечает за порог нахождения элементов внутри непересекающихся гипотез.
`find_one` - искать один элемент на изображении или несколько.
`elements_offset` - смещение координат. Когда распознавание происходит в выделенной рамке, то эта изображение в рамке отправляется в detect_all, распознавание происходит в координатной системе рамке, а после elements_offset используется для получения координат в системе всего изображения.
`debug_dir` - директория для дебага.
`det_names` - лист с названиями элементов для распознавания или None
`bga_szk` - что-то связанное с размерами bga

Возвращает:
`elements` -  лист классов Element

#### `detect_BGA_params`
Вспомогательная функция для распознавания BGA. Используется для нахождения попорота платы. Поэтому вызывается по окончанию сканирования платы, ещё до распознавания (И для того чтобы найти поворот распознаёт компоненты).

Аргументы:

`gc` - см. выше
`img`- см. выше
`types_filename`- см. выше

`pix_per_mm` - количество пикселей на миллиметр.

Возвращает:
`ang` - угол в градусах, на который следует повернуть плату
`pitch` - используется для сравнения с BGA эталонами
`points` - используется для сравнения с BGA эталонами

## train.py

Файл для обучения классификаторов. Вызывается из командной строки. Параметры изменяются в `__main__`

Для того чтобы обучение началось, в папку dumps нужно положить папки с классами элементов.

## utils.py
Множество математических функций, использующихся в распознавании, но способных существовать отдельно.

## dumps

    clf_bga.dump - сохраненные внутренности класса Detector с обученным классификатором для bga
    clf_types.dump - сохраненные внутренности класса Detector с обученным классификатором для других типов
    
    bga.csv - файл с описанием для bga
    label.csv - файл с описанием элемента (шахматной доски). Классификатор вроде зашит в clf_types.
    types.csv - файл с описанием для других типов
    
    clusters.txt - файл с кластерами элементов, используется в обучении. Предназначение не ясно.